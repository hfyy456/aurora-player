"use strict";const k=require("node:path"),c=require("fs/promises"),r=require("electron");class W{constructor(e){this.Model=e}create(e){return new Promise((t,n)=>{let o=new this.Model(e);this.Model.create(o,(s,l)=>{s?(console.log("create error--> ",s),n(s)):(console.log("create result--> ",l),t(l))})})}findByRegex(e){let t=new RegExp(e,"i");return new Promise((n,o)=>{this.Model.find({name:{$regex:t}}).then(s=>{n(s)}).catch(s=>{o(s)})})}save(e){return new Promise((t,n)=>{new this.Model(e).save().then(s=>{t(s)}).catch(s=>{n(s)})})}findAll(e,t){return new Promise((n,o)=>{console.log(e,t),this.Model.find(e,t||null,(s,l)=>{s?(console.log("findAll error--> ",s),o(s)):(console.log("findAll results--> ",l),n(l))})})}findOne(e,t,n){return new Promise((o,s)=>{this.Model.findOne(e,t||null,n||null).then(l=>{o(l)}).catch(l=>{s(l)})})}findOneByOrder(e,t,n){return new Promise((o,s)=>{this.Model.findOne(e).sort({[t]:n}).exec(function(l,a){console.log(a),l?s(l):o(a)})})}findAllByPage(e,t){return new Promise((n,o)=>{this.Model.find().limit(e).skip(e*t).sort({createTime:-1}).then(s=>{n(s)}).catch(s=>{o(s)})})}updateOne(e,t){return new Promise((n,o)=>{console.log(e,t),this.Model.updateOne(e,t,(s,l)=>{s?(console.log("update error--> ",s),o(s)):(console.log("update results--> ",l),n(l))})})}remove(e){return new Promise((t,n)=>{this.Model.remove(e,(o,s)=>{o?(console.log("remove error--> ",o),n(o)):(console.log("remove result--> ",s),t(s))})})}}const N={oss:{region:"oss-cn-hangzhou",accessKeyId:"LTAI5tRaV4Ng4PWUA1haq3Bv",accessKeySecret:"UpNFdvkTI6hF056wcHmDEmonbZzLUT",bucket:"hfsmusicplayer"},mongodb:{user:"root",pass:"root",host:"154.39.65.160",port:"32323",db:"blog"}},_=require("mongoose"),b=N.mongodb;function U(){let i="mongodb://",e=b.db;return i+=`${b.host}:${b.port}`,i+=`/${e}`,i}function z(){return{useNewUrlParser:!0,useUnifiedTopology:!0}}let O=_.createConnection(U(),z());O.on("connected",function(){console.log(new Date().getTime()),console.log("Mongoose连接至 ："+U())});O.on("error",function(i){console.log("Mongoose 连接失败，原因: "+i)});O.on("disconnected",function(){console.log("Mongoose 连接关闭")});let{Schema:K}=require("mongoose");const V=new K({name:String,url:String,createTime:{type:Date,default:new Date},editTime:{type:Date,default:new Date}},{runSettersOnQuery:!0});let B;try{B=O.model("Lrc",V,"lrc")}catch(i){console.log(i)}const E=B;class H extends W{constructor(){super(E)}}const Q=require("ali-oss");class J{constructor(){this.config=N.oss,this.client=this.connect()}connect(){return new Q({...this.config})}async list(){const e=await this.client.list();console.log(e)}async getBuffer(e){try{const t=await this.client.get(e);return console.log(t),t.content}catch(t){console.log(t)}}}const y=require("path"),q=require("fs"),j=y.join(__dirname,"/saveData"),Z="config.json",G=require("music-metadata");let x=new H;const X=new J;function Y(i){return i.toString("utf-8")}const C={playList:{},curPlayList:"",curMusic:"",musicInfos:{},audioOptions:{volume:80},lrcInfo:{modifyTime:0,path:"",list:[]},index:0};class ee{constructor(){this.file=y.join(j,Z),this.json=null,this.loadData()}saveItem(){x.save({name:"下一站天后",url:"111"})}async getList(){return x.findAllByPage(0,9999)}async findOnlineLrc(e){return await x.findByRegex(e)}getConfig(){return this.json}setConfig(e,t){this.json[e]=t,this.saveData()}async getOnlineLrc(e){return await X.getBuffer(e)}async getLrc(e){let t=null;if(!t){let n=await this.findOnlineLrc(e.title);if(console.log(n,typeof n,"res"),n.length>0){let o=n[0],s=await this.getOnlineLrc(o.name);t=await this.loadLrc(Y(s),!0)}}return t}async loadLrc(e,t=!1){let n=null;t?n=e.split("["):n=(await c.readFile(y.join(this.json.lrcInfo.path,e),{encoding:"utf-8"})).split("[");const o=/([0-9]\d):([0-5]\d)/;let s=[];for(let l=0;l<n.length;l++)if(n[l]="["+n[l],n[l]=n[l].replace(/\r\n\r\n/,""),n[l]=n[l].replace(/\r\n/,""),o.test(n[l])){let a=n[l].split("]"),w=a[0].split("[")[1].split(":"),P=w[0]*1*60+w[1]*1,g=parseInt(P);s.push({seconds:g,content:a[1]})}return s}async loadLrcs(e){let t=await c.readdir(e),n=await c.stat(e),o=parseInt(n.mtimeMs),s=[],l=t.length;for(let a=0;a<l;a++){let d=t[a];y.extname(d)==".lrc"&&s.push(d)}this.json.lrcInfo={...this.json.lrcInfo,list:s,path:e,modifyTime:o},this.saveData()}async addPlaylist(e){let t=await c.stat(e),n=parseInt(t.mtimeMs),o=await this.readMusicFiles(e);this.json.playList[e]={list:o,type:"directory",modifyTime:n,name:"本地目录",index:this.json.index+=1,key:e},this.saveData()}async getPlayList(e){if(!this.json.playList[e])await this.addPlaylist(e);else{let t=await c.stat(e);parseInt(t.mtimeMs)!=this.json.playList[e].modifyTime&&await this.addPlaylist(e)}return this.json.playList[e]}saveData(){let e=JSON.stringify(this.json);q.writeFile(this.file,e,function(){})}async readMusicFiles(e){let t=await c.readdir(e);var n=[];if(!t)return n;let o=0,s=t.length;const l=new Date().getTime();for(let d=0;d<s;d++){let S=t[d],w=y.extname(S);if(w===".flac"||w===".mp3"){let P=y.join(e,S);const g=await G.parseFile(P);let M={id:o++,url:P};M.title=g.common.title,M.artist=g.common.artist,M.album=g.common.album,M.duration=g.format.duration,n.push(M)}}const a=new Date().getTime();return console.log(a-l),n}async loadData(){console.log(this.file);var e=this;try{const t=q.readFileSync(e.file,"UTF-8").toString();e.json=JSON.parse(t)}catch{await c.access(j).then(o=>{}).catch(async o=>{await c.mkdir(j)});let n=JSON.stringify(C);await c.writeFile(e.file,n,{flag:"w"}),e.json=C}}}const te=new ee;function f(i,e=0,t="success"){return{code:e,data:typeof i=="object"?JSON.stringify(i):i,msg:t}}const ne=require("electron-store"),ie=new ne;let T=null,m=null;function se(){r.ipcMain.handle("openFileSystem",async i=>{const e=r.dialog.showOpenDialogSync({properties:["openDirectory"],defaultPath:"./"});return e?(T=e[0],m=await r.app.config.getPlayList(T),r.app.config.setConfig("curPlayList",m.key),r.app.config.loadLrcs(T),f({playList:m})):f(1,{})}),r.ipcMain.on("getDefaultList",async i=>{let e=r.app.config.getConfig();e.curPlayList==""&&i.sender.send("getPlaylist",f(1,{playList:null})),m=await r.app.config.getPlayList(e.curPlayList),r.app.config.setConfig("curPlayList",m.key),i.sender.send("getPlaylist",f({playList:m}))}),r.ipcMain.handle("clearStore",()=>{ie.clear(),console.log("clear")})}const oe=require("electron-store"),I=new oe,le=require("http"),re=require("music-metadata");let u=I.get("curMusic"),L=null,D=0;function ae(i,e){ue(t=>{i.loadURL(e)}),r.ipcMain.on("switchMusic",async(t,n)=>{u=JSON.parse(n)||null,v(t,u)}),r.ipcMain.on("startPlay",async t=>{let n;u?n=u:n=JSON.stringify(F[0]),v(t,n)}),r.ipcMain.on("setVolume",async(t,n)=>{t.sender.send("setVolume",n)}),r.ipcMain.on("pausePlay",async(t,n)=>{t.sender.send("pausePlay")}),r.ipcMain.on("nextPlay",async(t,n)=>{!L&&F();let o=u.id,s=0;o>=D?s=0:s=o+1,console.log(D,s,o),u=ce(s),console.log(u),v(t,u)})}async function v(i,e){let t;typeof e=="object"?t=JSON.stringify(e):e=JSON.parse(e),I.set("curMusic",t||JSON.stringify(e)),i.sender.send("switchMusic",f({ms:e}));const n=await fe(e);let o=await r.app.config.getLrc({artist:n.common.artist,title:n.common.title});i.sender.send("lrcReader",f({lrc:o})),i.sender.send("getMediaInfo",f({meta:n.common}))}function F(){L=JSON.parse(I.get("curList"));for(const i of L)D=Math.max(i.id,D);return L}function ce(i){for(const e of L)if(e.id==i)return e}function ue(i){const e=le.createServer(de).listen(0,()=>{i(e.address().port)});return e}function de(i,e){const t=decodeURIComponent(i.url),n=path.extname(t);if(allowKeys.indexOf(n)<0)return notFound(e);const o=path.join(t.substring(1));if(!fs.existsSync(o))return notFound(e);ms.pipe(i,e,o)}async function fe(i){return typeof i=="string"&&(i=JSON.parse(i)),await re.parseFile(i.url)}const{app:h,BrowserWindow:A,ipcMain:$}=require("electron");require("path");require("electron-squirrel-startup")&&h.quit();new J;const ge=k.join(__dirname,"./preload.js");let p=null;const R=()=>{p=new A({title:"Main window",height:650,useContentSize:!0,width:900,resizable:!1,backgroundColor:"#00000000",transparent:!0,frame:!1,webPreferences:{preload:ge,nodeIntegration:!0,contextIsolation:!1,webSecurity:!1}});const i="http://localhost:5173";p.loadURL(i),p.webContents.openDevTools(),ae(p,i)};h.on("ready",R);h.config=te;h.on("window-all-closed",()=>{process.platform!=="darwin"&&h.quit()});h.on("activate",()=>{A.getAllWindows().length===0&&R()});se();$.handle("closeWindow",()=>{p.close()});$.handle("minimizeWindow",()=>{p.minimize()});
